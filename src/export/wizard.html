<!DOCTYPE html>
<html>
<head>
    <title>Export Tasks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            font-size: 13px;
        }
        
        .wizard-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .wizard-header {
            background: linear-gradient(135deg, #34A853 0%, #4285F4 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .wizard-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .wizard-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .step.active .step-number {
            background: #34A853;
            color: white;
        }
        
        .step.completed .step-number {
            background: #4285F4;
            color: white;
        }
        
        .step-label {
            font-weight: 500;
            color: #333;
        }
        
        .step-connector {
            width: 60px;
            height: 2px;
            background: #e0e0e0;
            margin: 0 20px;
        }
        
        .wizard-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .step-content {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .step-content.active {
            display: block;
        }
        
        .step-header {
            margin-bottom: 30px;
        }
        
        .step-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .step-description {
            color: #666;
            line-height: 1.5;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #34A853;
            box-shadow: 0 0 0 3px rgba(52, 168, 83, 0.1);
        }
        
        .task-list {
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .task-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:hover {
            background-color: #f8f9fa;
        }
        
        .task-checkbox {
            margin-right: 12px;
        }
        
        .task-details {
            flex: 1;
        }
        
        .task-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .task-meta {
            color: #666;
            font-size: 12px;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        /* Batch card styles */
        .batch-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .batch-card:hover {
            border-color: #34A853;
            box-shadow: 0 2px 8px rgba(52, 168, 83, 0.2);
        }
        
        .batch-card.selected {
            border-color: #34A853;
            background-color: #f8fff8;
            box-shadow: 0 2px 8px rgba(52, 168, 83, 0.2);
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .batch-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .batch-date {
            color: #666;
            font-size: 13px;
        }
        
        .batch-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .batch-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        
        .batch-stat-value {
            font-weight: 600;
        }
        
        .batch-stat.staged .batch-stat-value {
            color: #34A853;
        }
        
        .batch-stat.failed .batch-stat-value {
            color: #EA4335;
        }
        
        .batch-stat.delivered .batch-stat-value {
            color: #4285F4;
        }
        
        .batch-attention {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-exportable {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-exported {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status-failed {
            background: #ffebee;
            color: #c62828;
        }
        
        .client-folder-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
        }
        
        .folder-validation {
            margin-top: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .alert-error {
            background-color: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .alert-info {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            color: #0d47a1;
        }
        
        .progress-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 25px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .progress-stats {
            color: #666;
            font-size: 14px;
        }
        
        .progress-bar {
            width: 100%;
            height: 28px;
            background-color: #f0f0f0;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34A853 0%, #4285F4 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: bold;
        }
        
        .export-log {
            max-height: 250px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 4px;
            color: #666;
        }
        
        .log-entry.success {
            color: #34A853;
        }
        
        .log-entry.error {
            color: #EA4335;
        }
        
        .log-entry.info {
            color: #4285F4;
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-value.success {
            color: #34A853;
        }
        
        .stat-value.error {
            color: #EA4335;
        }
        
        .stat-value.info {
            color: #4285F4;
        }
        
        .stat-label {
            color: #666;
            font-size: 13px;
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #34A853;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #2e7d32;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 168, 83, 0.3);
        }
        
        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #e8e8e8;
        }
        
        .btn-danger {
            background-color: #EA4335;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #d32f2f;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Header -->
        <div class="wizard-header">
            <div class="wizard-title">Export Tasks</div>
            <div class="wizard-subtitle">Export completed tasks directly to client destination</div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Select Tasks</div>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Export Progress</div>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Results</div>
            </div>
        </div>

        <!-- Content -->
        <div class="wizard-content">
            <!-- Step 1: Select Export Batch -->
            <div class="step-content active" id="step-1">
                <div class="step-header">
                    <div class="step-title">Select Export Batch & Client Folder</div>
                    <div class="step-description">
                        Choose an export batch and specify the client destination folder.
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-label">Available Export Batches</div>
                    <div id="batch-list" class="task-list">
                        <div class="text-center mt-20" style="padding: 40px;">
                            Loading available export batches...
                        </div>
                    </div>
                    <div id="batch-summary" class="mt-20" style="color: #666; font-size: 14px; display: none;">
                        <!-- Batch summary will be populated here -->
                    </div>
                </div>

                <div class="client-folder-section">
                    <div class="form-group">
                        <div class="form-label">Client Folder</div>
                        <input type="text" 
                               id="client-folder-input" 
                               class="form-control" 
                               placeholder="Enter Google Drive folder ID or paste folder URL"
                               autocomplete="off">
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            Paste the full Google Drive URL or just the folder ID
                        </div>
                    </div>
                    
                    <div id="folder-validation" class="folder-validation hidden">
                        <div id="folder-success" class="alert alert-success hidden">
                            <strong>✓ Folder validated</strong><br>
                            <span id="folder-details"></span>
                        </div>
                        <div id="folder-error" class="alert alert-error hidden">
                            <strong>✗ Invalid folder</strong><br>
                            <span id="folder-error-message"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Export Progress -->
            <div class="step-content" id="step-2">
                <div class="step-header">
                    <div class="step-title">Export in Progress</div>
                    <div class="step-description">
                        Exporting selected tasks to client folder. This may take a few minutes.
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-header">
                        <div class="progress-title" id="progress-title">Initializing export...</div>
                        <div class="progress-stats" id="progress-stats">0/0 tasks</div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill">0%</div>
                    </div>
                    
                    <div class="export-log" id="export-log">
                        <div class="log-entry">Starting export operation...</div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Results -->
            <div class="step-content" id="step-3">
                <div class="step-header">
                    <div class="step-title">Export Complete</div>
                    <div class="step-description">
                        Export operation finished. Review the results below.
                    </div>
                </div>

                <div class="results-summary" id="results-summary">
                    <!-- Summary stats will be populated here -->
                </div>

                <div id="export-success" class="alert alert-success">
                    <strong>✓ Export completed successfully!</strong><br>
                    All selected tasks have been exported to the client folder.
                </div>

                <div id="export-partial" class="alert alert-info hidden">
                    <strong>⚠ Partial export completed</strong><br>
                    Some tasks failed during export. See details in the log above.
                </div>

                <div id="export-failed" class="alert alert-error hidden">
                    <strong>✗ Export failed</strong><br>
                    The export operation encountered critical errors.
                </div>

                <div class="form-group">
                    <div class="form-label">Client Folder</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" 
                               id="result-folder-link" 
                               class="form-control" 
                               readonly>
                        <button type="button" 
                                class="btn btn-secondary" 
                                onclick="openClientFolder()">
                            📁 Open Folder
                        </button>
                    </div>
                </div>

                <div id="action-buttons" class="mt-20">
                    <button type="button" 
                            class="btn btn-danger hidden" 
                            onclick="retryFailedExports()"
                            id="btn-retry">
                        🔄 Retry Failed Tasks
                    </button>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="wizard-actions">
            <button type="button" 
                    id="btn-back" 
                    class="btn btn-secondary" 
                    onclick="previousStep()" 
                    disabled>
                ← Back
            </button>
            
            <div>
                <button type="button" 
                        id="btn-cancel" 
                        class="btn btn-secondary" 
                        onclick="google.script.host.close()">
                    Cancel
                </button>
                
                <button type="button" 
                        id="btn-next" 
                        class="btn btn-primary" 
                        onclick="nextStep()"
                        disabled>
                    Start Export
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let selectedBatch = null;
        let clientFolder = null;
        let exportResult = null;
        let currentExportId = null;

        // Initialize wizard
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableBatches();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Client folder input
            document.getElementById('client-folder-input').addEventListener('input', function() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(validateClientFolder, 1000);
            });

            document.getElementById('client-folder-input').addEventListener('blur', validateClientFolder);
        }

        function loadAvailableBatches() {
            const container = document.getElementById('batch-list');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        renderBatches(result.batches, result.summary);
                    } else {
                        container.innerHTML = '<div class="text-center" style="padding: 40px; color: #EA4335;">Failed to load export batches: ' + result.error + '</div>';
                    }
                })
                .withFailureHandler(function(error) {
                    container.innerHTML = '<div class="text-center" style="padding: 40px; color: #EA4335;">Error loading export batches: ' + error + '</div>';
                })
                .getAvailableExportBatchesForUI();
        }

        function renderBatches(batches, summary) {
            const container = document.getElementById('batch-list');
            const summaryContainer = document.getElementById('batch-summary');
            
            if (batches.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">No export batches available. Stage some tasks first using "Stage Tasks for Export".</div>';
                summaryContainer.style.display = 'none';
                return;
            }
            
            // Show summary
            summaryContainer.innerHTML = `
                Found ${summary.total} export batch${summary.total !== 1 ? 'es' : ''} 
                with ${summary.totalTasks} total tasks
                ${summary.withFailures > 0 ? ` (${summary.withFailures} with failures)` : ''}
            `;
            summaryContainer.style.display = 'block';
            
            container.innerHTML = batches.map(batch => {
                const createdDate = batch.createdDate ? new Date(batch.createdDate).toLocaleDateString() : 'Unknown';
                
                return `
                <div class="batch-card" onclick="selectBatch('${batch.exportBatchId}')">
                    <div class="batch-header">
                        <div>
                            <div class="batch-title">${batch.exportBatchId}</div>
                            <div class="batch-date">Created: ${createdDate}</div>
                        </div>
                        ${batch.needsAttention ? '<div class="batch-attention">⚠ Needs Attention</div>' : ''}
                    </div>
                    
                    <div class="batch-stats">
                        ${batch.stagedTasks > 0 ? `
                        <div class="batch-stat staged">
                            <span class="batch-stat-value">${batch.stagedTasks}</span>
                            <span>Ready</span>
                        </div>
                        ` : ''}
                        
                        ${batch.failedTasks > 0 ? `
                        <div class="batch-stat failed">
                            <span class="batch-stat-value">${batch.failedTasks}</span>
                            <span>Failed</span>
                        </div>
                        ` : ''}
                        
                        ${batch.deliveredTasks > 0 ? `
                        <div class="batch-stat delivered">
                            <span class="batch-stat-value">${batch.deliveredTasks}</span>
                            <span>Delivered</span>
                        </div>
                        ` : ''}
                        
                        <div class="batch-stat">
                            <span class="batch-stat-value">${batch.totalTasks}</span>
                            <span>Total</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function selectBatch(batchId) {
            // Remove previous selection
            document.querySelectorAll('.batch-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new batch
            event.target.closest('.batch-card').classList.add('selected');
            selectedBatch = batchId;
            
            // Update next button state
            updateNextButtonState();
        }

        function validateClientFolder() {
            const input = document.getElementById('client-folder-input');
            const folderInput = input.value.trim();
            
            if (!folderInput) {
                hideValidationResults();
                updateNextButtonState();
                return;
            }

            // Show loading state
            input.classList.add('loading');
            hideValidationResults();

            // Extract folder ID from URL if provided
            let folderId = folderInput;
            const urlMatch = folderInput.match(/folders\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                folderId = urlMatch[1];
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    input.classList.remove('loading');
                    
                    if (result.valid) {
                        showValidationSuccess(result);
                        clientFolder = result;
                    } else {
                        showValidationError(result.error);
                        clientFolder = null;
                    }
                    updateNextButtonState();
                })
                .withFailureHandler(function(error) {
                    input.classList.remove('loading');
                    showValidationError(error.toString());
                    clientFolder = null;
                    updateNextButtonState();
                })
                .validateClientFolder(folderId);
        }

        function showValidationSuccess(result) {
            const validation = document.getElementById('folder-validation');
            const success = document.getElementById('folder-success');
            const error = document.getElementById('folder-error');
            const details = document.getElementById('folder-details');
            
            details.textContent = `${result.folderName} (ID: ${result.folderId})`;
            
            success.classList.remove('hidden');
            error.classList.add('hidden');
            validation.classList.remove('hidden');
        }

        function showValidationError(errorMessage) {
            const validation = document.getElementById('folder-validation');
            const success = document.getElementById('folder-success');
            const error = document.getElementById('folder-error');
            const message = document.getElementById('folder-error-message');
            
            message.textContent = errorMessage;
            
            error.classList.remove('hidden');
            success.classList.add('hidden');
            validation.classList.remove('hidden');
        }

        function hideValidationResults() {
            document.getElementById('folder-validation').classList.add('hidden');
        }

        function updateNextButtonState() {
            const nextBtn = document.getElementById('btn-next');
            const canProceed = selectedBatch && clientFolder && clientFolder.valid;
            nextBtn.disabled = !canProceed;
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!selectedBatch || !clientFolder) {
                    return;
                }
                startExport();
            }
            
            currentStep++;
            updateStepDisplay();
            updateButtons();
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
                updateButtons();
            }
        }

        function updateStepDisplay() {
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show current step content
            document.getElementById(`step-${currentStep}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((el, index) => {
                const stepNum = index + 1;
                el.classList.remove('active', 'completed');
                
                if (stepNum === currentStep) {
                    el.classList.add('active');
                } else if (stepNum < currentStep) {
                    el.classList.add('completed');
                }
            });
        }

        function updateButtons() {
            const btnBack = document.getElementById('btn-back');
            const btnNext = document.getElementById('btn-next');
            const btnCancel = document.getElementById('btn-cancel');

            btnBack.disabled = currentStep === 1;
            
            if (currentStep === 3) {
                btnNext.style.display = 'none';
                btnCancel.textContent = 'Close';
            } else {
                btnNext.style.display = 'inline-flex';
                btnCancel.textContent = 'Cancel';
            }
        }

        function startExport() {
            const progressTitle = document.getElementById('progress-title');
            const progressStats = document.getElementById('progress-stats');
            const progressFill = document.getElementById('progress-fill');
            const exportLog = document.getElementById('export-log');
            
            // Disable navigation
            document.getElementById('btn-back').disabled = true;
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-cancel').disabled = true;
            
            // Initialize progress
            progressTitle.textContent = 'Initializing export...';
            progressStats.textContent = `0/${selectedTasks.length} tasks`;
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';
            exportLog.innerHTML = '<div class="log-entry">Starting export operation...</div>';
            
            // Start export
            google.script.run
                .withSuccessHandler(function(result) {
                    exportResult = result;
                    currentExportId = result.exportId;
                    
                    if (result.success) {
                        progressTitle.textContent = 'Export completed successfully!';
                        progressFill.style.width = '100%';
                        progressFill.textContent = '100%';
                        progressStats.textContent = `${result.stats.completedTasks}/${result.stats.totalTasks} tasks completed`;
                        
                        exportLog.innerHTML += '<div class="log-entry success">✓ Export operation completed successfully</div>';
                        
                        // Auto-advance to results
                        setTimeout(() => {
                            showExportResults(result);
                            nextStep();
                        }, 1500);
                    } else {
                        progressTitle.textContent = 'Export completed with errors';
                        progressFill.style.width = '100%';
                        progressFill.textContent = 'Done';
                        
                        exportLog.innerHTML += '<div class="log-entry error">✗ Export completed with errors</div>';
                        if (result.error) {
                            exportLog.innerHTML += `<div class="log-entry error">Error: ${result.error}</div>`;
                        }
                        
                        // Show results anyway
                        setTimeout(() => {
                            showExportResults(result);
                            nextStep();
                        }, 2000);
                    }
                })
                .withFailureHandler(function(error) {
                    progressTitle.textContent = 'Export failed';
                    progressFill.style.width = '100%';
                    progressFill.classList.add('error');
                    
                    exportLog.innerHTML += '<div class="log-entry error">✗ Export failed: ' + error + '</div>';
                    
                    // Re-enable navigation
                    document.getElementById('btn-back').disabled = false;
                    document.getElementById('btn-cancel').disabled = false;
                })
                .startExportWizard(selectedBatch, clientFolder.folderId);
        }

        function showExportResults(result) {
            const summaryContainer = document.getElementById('results-summary');
            const stats = result.stats || {};
            
            summaryContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value success">${stats.completedTasks || 0}</div>
                    <div class="stat-label">Tasks Exported</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value ${stats.failedTasks > 0 ? 'error' : ''}">${stats.failedTasks || 0}</div>
                    <div class="stat-label">Failed Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value info">${stats.totalFilesCopied || 0}</div>
                    <div class="stat-label">Files Copied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round((result.duration || 0) / 1000)}s</div>
                    <div class="stat-label">Duration</div>
                </div>
            `;
            
            // Update success/error messages
            if (!result.success || stats.failedTasks > 0) {
                document.getElementById('export-success').classList.add('hidden');
                if (stats.completedTasks > 0) {
                    document.getElementById('export-partial').classList.remove('hidden');
                } else {
                    document.getElementById('export-failed').classList.remove('hidden');
                }
                
                // Show retry button if there are failures
                if (stats.failedTasks > 0) {
                    document.getElementById('btn-retry').classList.remove('hidden');
                }
            }
            
            // Set client folder link
            if (clientFolder) {
                document.getElementById('result-folder-link').value = clientFolder.folderUrl;
            }
        }

        function openClientFolder() {
            if (clientFolder && clientFolder.folderUrl) {
                window.open(clientFolder.folderUrl, '_blank');
            }
        }

        function retryFailedExports() {
            const btn = document.getElementById('btn-retry');
            btn.disabled = true;
            btn.textContent = '🔄 Retrying...';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert(`Successfully reset ${result.resetCount} failed exports. You can now retry the export.`);
                        // Reload the page to start fresh
                        location.reload();
                    } else {
                        alert('Failed to reset exports: ' + result.error);
                        btn.disabled = false;
                        btn.textContent = '🔄 Retry Failed Tasks';
                    }
                })
                .withFailureHandler(function(error) {
                    alert('Error resetting exports: ' + error);
                    btn.disabled = false;
                    btn.textContent = '🔄 Retry Failed Tasks';
                })
                .resetFailedExports();
        }

        // Initialize display
        updateButtons();
    </script>
</body>
</html>